% Outils divers à charger
\RequirePackage{fontspec,xunicode,polyglossia}
\setmainlanguage{french}
\XeTeXinputnormalization 1
\RequirePackage{etoolbox}
\RequirePackage{xstring}
\RequirePackage{hyperref}
\RequirePackage{xargs}
\RequirePackage{xspace}
\RequirePackage{imakeidx}
\RequirePackage{SIunits}
\RequirePackage{longtable}
\RequirePackage{rotating}
\RequirePackage{arydshln}

% Commande pour afficher les siècles
\DeclareRobustCommand{\cRM}[1]{\MakeUppercase{\expandafter\romannumeral #1}}	% Capital
\DeclareRobustCommand{\cRm}[1]{\textsc{\romannumeral #1}}	% Petit majuscule
\DeclareRobustCommand{\crm}[1]{\romannumeral #1}
\DeclareRobustCommand{\siecle}[1]{\cRm{#1}\textsuperscript{e}~siècle}
\DeclareRobustCommand{\siecles}[2]{\cRm{#1}-\cRm{#2}\textsuperscript{e}~siècles}
% Bibleref

\RequirePackage{bibleref-french}
\biblerefstyle{defaultshorter}

% csquotes
\usepackage{csquotes}


% Pour les références bibliques 

\newcommand{\bibleref}[1]{
	%Commande pour afficher un passage biblique, c'est elle qui est appellée par tt les autres
	\def\passage##1|##2|##3|{\bibleverse{##1}(##2)\ifstrempty{##3}{}{ (##3)}}% L'affichage de chaque passage : 1) livre 2) passage 3) version
	% On commence par faire une liste des passages
	\def\passages{}% Liste des passages
	\numdef\nbpassages{0}% Nbr total de passages
	\DeclareListParser*{\trouvepassages}{+}% Le + est un séparateur
	\trouvepassages{\numdef\nbpassages{\nbpassages+1}\listadd\passages}{#1}% On remplit la liste des passage
	%
	% On la parcourt ensuite
	\numdef\cptpassage{0}% Le nombre de passage courant
	\renewcommand{\do}[1]{% Ce qu'on effectue à chaque boucle
		\numdef\cptpassage{\cptpassage+1}% Incrémenter le compteur du passage courant
		\IfSubStr[2]{##1}{|}% Tester si on a 2 ou 3 élèments dans le passage
			{\passage##1|} % Si 3 élèments, donc 2 |
			{\passage##1||}% Si 2 élèments, donc 1 |
		\ifnumequal{\nbpassages}{\cptpassage}{.}{ ; }% y a t'il encore des passages ensuite?
	}%
	\dolistloop{\passages}% Boucler sur tt les passages
	%
}

\newcommand*{\biblefr}[1]{\emph{#1}} % pour un fragment de bible seulement
\newcommand*{\bible}[2]{%
	\ifnumbering\let\footnote\footnoteA\fi%
	\ifnumberingR\let\footnote\footnoteA\fi%
	%#1 : passage
	%#2 : texte
	\emph{#2}\footnote{\bibleref{#1}}%
}
\newcommand*{\bibleall}[1]{%
	%#1 : passage
	\ifnumbering\let\footnote\footnoteA\fi%
	\ifnumberingR\let\footnote\footnoteA\fi%
	\footnote{\emph{Cf}. \bibleref{#1}}%
	}

% pour les notes de traductions
\newcommand{\ctrad}[2]{\edtext{#1}{\Bfootnote{#2}}}
\newcommand{\lit}[1]{\emph{lit.} : #1}
\newcommand{\altertrad}[1]{\emph{autre trad.} : #1}

% pour les index
\newif\ifvoirindex

%% nom de personnes
\makeindex[name=np,title={Noms de personnes}]
\newcommandx{\np}[3][1,2,usedefault]{%
	#3\indexn[#1][#2]{#3}{np}%
}
\newcommandx{\indexnp}[3][1,2,usedefault]{\indexn[#1][#2]{#3}{np}}

% nom de lieu
\makeindex[name=nl,title={Noms de lieux}]
\newcommandx{\nl}[3][1,2,usedefault]{%
	#3\indexn[#1][#2]{#3}{nl}%
}
\newcommandx{\indexnl}[3][1,2,usedefault]{\indexn[#1][#2]{#3}{nl}}

% nom de peuple
\makeindex[name=npe,title={Noms de peuples}]
\newcommandx{\npe}[3][1,2,usedefault]{%
	#3\indexn[#1][#2]{#3}{npe}%
}
\newcommandx{\indexnpe}[3][1,2,usedefault]{\indexn[#1][#2]{#3}{npe}}
%%% commande générale pour indexer noms propre
\newcommandx{\indexn}[4][1,2,usedefault]{%
	\ifvoirindex%
		\ifnumbering%% si dans section numeroté
			\ledsidenote{#4:#1,#2,#3}%
		\else%
			\marginpar{#4:#1,#2,#3}%
		\fi%
	\fi%
	\ifstrempty{#1}{%
		\ifstrempty{#2}{\index[#4]{#3}}{\index[#4]{#3|see{#2}}\index[#4]{#2}}%cas de renvoi
	}{%
		\ifstrempty{#2}{\index[#4]{#3, #1}}{\index[#4]{#3, #1|see{#2}}\index[#4]{#2}}%
	}%
}

% Diverse commandes
\newcommand{\cf}{cf.~}
\newcommandx{\sic}[1][1,usedefault]{%
	\ifstrempty{#1}{ (\emph{sic})}{#1\sic}%
}
% Manuscrit

\newcommand{\ms}[1]{\emph{#1}}
% Stemma

\RequirePackage{float}
\newfloat{stemma}{h}{stemma}
\floatname{stemma}{Stemma}

\newcommand{\insertstemma}[2]{
	\begin{stemma}
		\centering
		\input{schemas/stemma/#1}
		\caption{#2}\label{stemma:#1}
	\end{stemma}
}
\newcommand{\refstemma}[1]{stemma~\ref{stemma:#1}\xspace}
% Commande pour afficher des textes en //

\newenvironment{col}{%
\setlength{\columnrulewidth}{0.5pt}
\vspace{0.5ex}
\small
\begin{pairs}
	\emergencystretch=0.05\hsize
	%\singlespacing
	\newenvironment{qenglish}{\begin{Leftside}\begin{english}\beginnumbering\autopar}
{

\endnumbering\end{english}\end{Leftside}}


	\newenvironment{qlatin}{\begin{Leftside}\begin{hyphenrules}{latin}\beginnumbering\autopar}
{

\endnumbering\end{hyphenrules}\end{Leftside}}


	\newenvironment{qgreek}{\begin{Leftside}\begin{hyphenrules}{greek}\beginnumbering\autopar}
{

\endnumbering\end{hyphenrules}\end{Leftside}}
	
	\newenvironment{trad}{\begin{Rightside}\beginnumbering\autopar}
{

\endnumbering\end{Rightside}}
}
{
\Columns
\end{pairs}
}
% tableau
\setlength{\doublerulesep}{0pt}
\newcommand{\titrecolonne}[1]{\hfill \emph{#1} \hfill}
% Charger eledmac en dernier, car il perturbe makeindex

\RequirePackage{eledmac,eledpar}
\shiftedpstartstrue
\newcommand{\titulus}[1]{\textbf{\emph{#1}}}
\newcommand{\saut}{}
\footparagraphX{A}
\renewcommand*{\Rlineflag}{}
\setstanzaindents{2,1}
\setcounter{stanzaindentsrepetition}{1}
\renewcommand{\hangingsymbol}{[\,}
